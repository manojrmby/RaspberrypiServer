# - name: create portainer volume
#   community.docker.docker_volume:
#     name: "portainer_data"

# - name: Deploy portainer
#   community.docker.docker_container:
#     name: portainer
#     image: portainer/portainer-ce
#     ports:
#       - "8000:8000"
#       - "9443:9443"
#     volumes:
#       - "/var/run/docker.sock:/var/run/docker.sock"
#       - "portainer_data:/data"
#     restart_policy: always
---

- name: Download docker-compose {{ docker_compose_version }}
  get_url:
    url: https://github.com/docker/compose/releases/download/{{ docker_compose_version }}/docker-compose-Linux-x86_64
    dest: ~/docker-compose
    mode: "+x"

- name: Check docker-compose exists
  stat: path=~/docker-compose
  register: docker_compose

- name: Move docker-compose to /usr/local/bin/docker-compose
  command: mv ~/docker-compose /usr/local/bin/docker-compose
  when: docker_compose.stat.exists

# REQUIRED PACKAGES FOR USING ANSIBLE DOCKER (for portainer installation below)
- name: Install related packages
  apt:
    name: "{{ packages }}"
    state: latest
  vars:
    packages:
      - python3-pip
      - mc

- name: Install python packages
  pip:
    name: docker

# https://docs.ansible.com/ansible/latest/collections/community/docker/docker_container_module.html#ansible-collections-community-docker-docker-container-module
- name: Create portainer container
  docker_container:
    name: portainer
    image: portainer/portainer-ce
    state: started
    recreate: yes
    restart_policy: always
    published_ports:
      - "8000:8000"
      - "9000:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data